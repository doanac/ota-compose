version: '3'

volumes:
  ota-ce-db:
  treehub-objects:

services:
  kafka:
    image: spotify/kafka

  ota-ce-db:
    image: mariadb:10.3.2
    command: --max_connections=120
    env_file:
      - ./.secrets
    volumes:
      - ota-ce-db:/var/lib/mysql
      - ./ota-ce-initialize.sql:/docker-entrypoint-initdb.d/ota-ce-initialize.sql

  treehub:
    image: advancedtelematic/treehub:0.1.27
    user: root
    env_file:
      - ./.secrets
    environment:
      AUTH_PROTOCOL: none
      BIND_PORT: '9001'
      DB_URL: jdbc:mariadb://ota-ce-db:3306/treehub
      KAFKA_HOST: kafka:9092
      REPORT_METRICS: "false"
      TREEHUB_LOCAL_STORE_PATH: "/treehub-objects"
      TREEHUB_STORAGE: local
    volumes:
      - treehub-objects:/treehub-objects/object-storage
      - ./wait-for:/wait-for
      - ./treehub-run.sh:/run.sh
    command: "/wait-for ota-ce-db:3306 -- /run.sh"
    entrypoint: ""
    depends_on:
      - ota-ce-db
      - kafka
