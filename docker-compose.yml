version: '3'

volumes:
  notary-db:
  treehub-db:
  treehub-objects:

services:
  kafka:
    image: spotify/kafka

  treehub-db:
    image: mariadb:10.3.2
    command: --max_connections=120
    environment:
      MYSQL_DATABASE: treehub
      MYSQL_USER: treehub
      MYSQL_PASSWORD: treehub
      MYSQL_ROOT_PASSWORD: randomRoot
    volumes:
      - treehub-db:/var/lib/mysql

  treehub:
    image: advancedtelematic/treehub:0.1.27
    user: root
    environment:
      AUTH_PROTOCOL: none
      BIND_PORT: '9001'
      DB_MIGRATE: 'true'
      DB_URL: jdbc:mariadb://treehub-db:3306/treehub
      KAFKA_HOST: kafka:9092
      REPORT_METRICS: "false"
      TREEHUB_LOCAL_STORE_PATH: "/treehub-objects"
      TREEHUB_STORAGE: local
    volumes:
      - treehub-objects:/treehub-objects/object-storage
      - ./wait-for:/wait-for
      - ./treehub-run.sh:/run.sh
    command: "/wait-for treehub-db:3306 -- /run.sh"
    entrypoint: ""
    depends_on:
      - treehub-db
      - kafka

  notary-db:
    image: mariadb:10.3.2
    volumes:
      - ./notary/mysql-initdb.d:/docker-entrypoint-initdb.d
      - notary-db:/var/lib/mysql
    environment:
      TERM: dumb
      MYSQL_ALLOW_EMPTY_PASSWORD: "true"
    command: mysqld --innodb_file_per_table

  notary-signer:
    image: foundriesio/notary:signer-0.6.1
    entrypoint: /usr/bin/env sh
    command: -c "./migrations/migrate.sh && notary-signer -config=/fixtures/signer-config.json"
    environment:
      DB_URL: "mysql://signer@tcp(notary-db:3306)/notarysigner?parseTime=True"
    volumes:
      - ./notary/fixtures:/fixtures
    depends_on:
      - notary-db

  notary-server:
    image: foundriesio/notary:server-0.6.1
    entrypoint: /usr/bin/env sh
    command: -c "./migrations/migrate.sh && notary-server -config=/fixtures/server-config.json"
    environment:
      DB_URL: "mysql://server@tcp(notary-db:3306)/notaryserver?parseTime=True"
    volumes:
      - ./notary/fixtures:/fixtures
    depends_on:
      - notary-db
      - notary-signer

  public-web:
    image: nginx
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
    ports:
      - 8080:80
